#!/usr/bin/env python3
"""
Phase 1: Audio Engine Test
==========================
miniaudioì™€ mutagenì„ ì‚¬ìš©í•œ ì˜¤ë””ì˜¤ ì¬ìƒ ë° ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í…ŒìŠ¤íŠ¸
"""

import sys
from pathlib import Path

# mutagenìœ¼ë¡œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
import mutagen
from mutagen.flac import FLAC

# miniaudioë¡œ ì˜¤ë””ì˜¤ ì •ë³´ í™•ì¸
import miniaudio


def test_metadata_extraction(file_path: str):
    """ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í…ŒìŠ¤íŠ¸"""
    print(f"\n{'='*60}")
    print(f"ğŸ“‹ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í…ŒìŠ¤íŠ¸: {Path(file_path).name}")
    print('='*60)
    
    try:
        audio = mutagen.File(file_path)
        
        if audio is None:
            print("âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            return None
        
        # ê¸°ë³¸ ì •ë³´
        info = audio.info
        print(f"\nğŸµ íŒŒì¼ ì •ë³´:")
        print(f"   í¬ë§·: {type(audio).__name__}")
        print(f"   ê¸¸ì´: {info.length:.2f}ì´ˆ ({int(info.length//60)}:{int(info.length%60):02d})")
        print(f"   Sample Rate: {info.sample_rate} Hz")
        print(f"   Channels: {info.channels}")
        
        # FLAC ì „ìš© ì •ë³´
        if hasattr(info, 'bits_per_sample'):
            print(f"   Bit Depth: {info.bits_per_sample} bit")
        if hasattr(info, 'bitrate'):
            print(f"   Bitrate: {info.bitrate} kbps")
        
        # íƒœê·¸ ì •ë³´
        print(f"\nğŸ·ï¸ íƒœê·¸ ì •ë³´:")
        tags_to_show = ['title', 'artist', 'album', 'date', 'genre', 'tracknumber']
        for tag in tags_to_show:
            value = audio.get(tag)
            if value:
                print(f"   {tag.capitalize()}: {value[0] if isinstance(value, list) else value}")
        
        return {
            'sample_rate': info.sample_rate,
            'channels': info.channels,
            'bit_depth': getattr(info, 'bits_per_sample', 16),
            'duration': info.length
        }
        
    except Exception as e:
        print(f"âŒ ì—ëŸ¬: {e}")
        return None


def test_miniaudio_info(file_path: str):
    """miniaudioë¡œ íŒŒì¼ ì •ë³´ í™•ì¸"""
    print(f"\n{'='*60}")
    print(f"ğŸ”Š miniaudio íŒŒì¼ ì •ë³´ í…ŒìŠ¤íŠ¸")
    print('='*60)
    
    try:
        info = miniaudio.get_file_info(file_path)
        print(f"\nğŸ“Š miniaudio ë¶„ì„ ê²°ê³¼:")
        print(f"   Sample Rate: {info.sample_rate} Hz")
        print(f"   Channels: {info.nchannels}")
        print(f"   Duration: {info.duration:.2f}ì´ˆ")
        print(f"   Sample Format: {info.sample_format.name}")
        print(f"   Sample Width: {info.sample_width} bytes")
        return info
    except Exception as e:
        print(f"âŒ ì—ëŸ¬: {e}")
        return None


def test_audio_devices():
    """ì‚¬ìš© ê°€ëŠ¥í•œ ì˜¤ë””ì˜¤ ì¥ì¹˜ í™•ì¸"""
    print(f"\n{'='*60}")
    print(f"ğŸ§ ì˜¤ë””ì˜¤ ì¥ì¹˜ ëª©ë¡")
    print('='*60)
    
    try:
        devices = miniaudio.Devices()
        playbacks = devices.get_playbacks()
        
        print(f"\nğŸ“¢ ì¬ìƒ ì¥ì¹˜ ({len(playbacks)}ê°œ):")
        for i, dev in enumerate(playbacks):
            print(f"   [{i}] {dev['name']}")
        
        return playbacks
    except Exception as e:
        print(f"âŒ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return []


def test_audio_playback(file_path: str, duration_seconds: float = 5.0):
    """ì˜¤ë””ì˜¤ ì¬ìƒ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ Nì´ˆ)"""
    print(f"\n{'='*60}")
    print(f"â–¶ï¸ ì˜¤ë””ì˜¤ ì¬ìƒ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ {duration_seconds}ì´ˆ)")
    print('='*60)
    
    try:
        # íŒŒì¼ ë””ì½”ë”©
        print(f"\në””ì½”ë”© ì¤‘...")
        decoded = miniaudio.decode_file(file_path)
        
        print(f"   Sample Rate: {decoded.sample_rate} Hz")
        print(f"   Channels: {decoded.nchannels}")
        print(f"   Sample Format: {decoded.sample_format.name}")
        print(f"   Duration: {decoded.duration:.2f}ì´ˆ")
        
        # ì¬ìƒ ì¥ì¹˜ ìƒì„±
        print(f"\nğŸ”Š ì¬ìƒ ì¤‘... (Ctrl+Cë¡œ ì¤‘ë‹¨)")
        
        # ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì¬ìƒ
        stream = miniaudio.stream_file(file_path)
        
        with miniaudio.PlaybackDevice(
            output_format=stream.sample_format,
            nchannels=stream.nchannels,
            sample_rate=stream.sample_rate
        ) as device:
            device.start(stream)
            
            import time
            for i in range(int(duration_seconds)):
                time.sleep(1)
                print(f"   ì¬ìƒ ì¤‘: {i+1}/{int(duration_seconds)}ì´ˆ")
            
        print("\nâœ… ì¬ìƒ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        return True
        
    except KeyboardInterrupt:
        print("\nâ¹ï¸ ì¬ìƒ ì¤‘ë‹¨ë¨")
        return True
    except Exception as e:
        print(f"âŒ ì¬ìƒ ì‹¤íŒ¨: {e}")
        return False


def main():
    """ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    print("\n" + "="*60)
    print("ğŸµ JuuxBox Audio Engine Test - Phase 1")
    print("="*60)
    
    # ìƒ˜í”Œ íŒŒì¼ ê²½ë¡œ
    sample_dir = Path("/project/juuxbox/Music_Sample")
    sample_files = list(sample_dir.glob("*.flac"))
    
    if not sample_files:
        print("âŒ ìƒ˜í”Œ FLAC íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        print(f"   ê²½ë¡œ: {sample_dir}")
        sys.exit(1)
    
    print(f"\nğŸ“ ë°œê²¬ëœ ìƒ˜í”Œ íŒŒì¼: {len(sample_files)}ê°œ")
    for f in sample_files:
        print(f"   - {f.name}")
    
    # ì²« ë²ˆì§¸ íŒŒì¼ë¡œ í…ŒìŠ¤íŠ¸
    test_file = str(sample_files[0])
    
    # 1. ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í…ŒìŠ¤íŠ¸
    metadata = test_metadata_extraction(test_file)
    
    # 2. miniaudio ì •ë³´ í…ŒìŠ¤íŠ¸
    audio_info = test_miniaudio_info(test_file)
    
    # 3. ì˜¤ë””ì˜¤ ì¥ì¹˜ ëª©ë¡
    devices = test_audio_devices()
    
    # 4. ì¬ìƒ í…ŒìŠ¤íŠ¸ (ì˜µì…˜)
    print(f"\n{'='*60}")
    print("ì¬ìƒ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ", end="")
    
    # ìë™ í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ìŠ¤í‚µ
    if len(sys.argv) > 1 and sys.argv[1] == "--auto":
        print("ìŠ¤í‚µ (--auto ëª¨ë“œ)")
    else:
        try:
            response = input()
            if response.lower() == 'y':
                test_audio_playback(test_file, duration_seconds=5)
        except EOFError:
            print("ìŠ¤í‚µ (ë¹„ëŒ€í™”í˜• ëª¨ë“œ)")
    
    # ê²°ê³¼ ìš”ì•½
    print(f"\n{'='*60}")
    print("ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
    print('='*60)
    
    if metadata:
        print(f"\nâœ… ë©”íƒ€ë°ì´í„° ì¶”ì¶œ: ì„±ê³µ")
        print(f"   - {metadata['sample_rate']} Hz / {metadata['bit_depth']} bit / {metadata['channels']} ch")
    else:
        print(f"\nâŒ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ: ì‹¤íŒ¨")
    
    if audio_info:
        print(f"âœ… miniaudio íŒŒì¼ ë¶„ì„: ì„±ê³µ")
    else:
        print(f"âŒ miniaudio íŒŒì¼ ë¶„ì„: ì‹¤íŒ¨")
    
    if devices:
        print(f"âœ… ì˜¤ë””ì˜¤ ì¥ì¹˜ íƒìƒ‰: {len(devices)}ê°œ ë°œê²¬")
    else:
        print(f"âš ï¸ ì˜¤ë””ì˜¤ ì¥ì¹˜ íƒìƒ‰: ì¥ì¹˜ ì—†ìŒ")
    
    print("\n" + "="*60)
    print("ğŸ‰ Phase 1 í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
    print("="*60 + "\n")


if __name__ == "__main__":
    main()
